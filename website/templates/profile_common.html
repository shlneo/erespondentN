{% extends "base.html" %}
{% block title %}–û–±—â–µ–µ - ErespondentN{% endblock %}
{% block content %}

<div class="profile_page">
    <div class = "rotation-fromareas">
        <div class = "rotation-fromareas_info"> 
            <span>
                <a class = "hover_a" href="/account">–ü—Ä–æ—Ñ–∏–ª—å</a>
            </span>
            <span> 
                <img src="{{ url_for('static', filename='img/icon_arroy.png')}}" alt="">
            </span>
            <span>
                <a>–û–±—â–µ–µ</a>
            </span>
        </div>
    </div>
    <div class="contener_row">
        {% block left_menu %}
            {{ super() }}
        {% endblock %}
        <div class="personal-info_area">
            
        <div class="answer-highlight-second" >
            <div class="highlight-icon">üí°</div>
            <p>–ü–æ—Å–ª–µ <strong>—Å–æ–∑–¥–∞–Ω–∏—è</strong> –ø–µ—Ä–≤–æ–≥–æ –æ—Ç—á–µ—Ç–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è <strong>–Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º</strong>.</p>
        </div>
                <form action="/add-personal-parametrs" method="POST">
                    <table>
                        <tr>
                            <td><span title = "–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º">–¢–∏–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span></div></td>
                            <td><input type="text" value="{{current_user.type}}" readonly></td>
                        </tr>
                        <tr>
                            <td>–§–∞–º–∏–ª–∏—è &#42;</td>
                            <td>                    
                                <div class="clear-input_container">
                                    <input type="text" name="second_name_common" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" 
                                    value="{{current_user.fio.split()[0] if current_user.fio else ''}}" 
                                    required id="second_name_input" maxlength="50">
                                    <span class="clear-btn">
                                        &times;
                                    </span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>–ò–º—è &#42;</td>
                            <td>                    
                                <div class="clear-input_container">
                                    <input type="text" name="name_common" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" 
                                value="{{current_user.fio.split()[1] if current_user.fio else ''}}" 
                                required id="name_input" maxlength="50">
                                    <span class="clear-btn">
                                         &times;
                                    </span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><span title = "–ù–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è">–û—Ç—á–µ—Å—Ç–≤–æ</span></td>
                            <td>                    
                                <div class="clear-input_container">
                                    <input type="text" name="patronymic_common" placeholder="–í–≤–µ–¥–∏—Ç–µ –æ—Ç—á–µ—Å—Ç–≤–æ (–Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" 
                                value="{{current_user.fio.split()[2] if current_user.fio else ''}}" 
                                id="patronymic_input" maxlength="50">
                                    <span class="clear-btn">
                                        &times;
                                    </span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td><span title = "–û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∑–∞ –∫–æ—Ç–æ—Ä—É—é –æ—Ç—á–∏—Ç—ã–≤–∞—é—Ç—Å—è">–ü—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–µ &#42;</span></td>
                            <td style = "display: flex; flex-direction: row;">
                                <input 
                                    class = "pred_name" type="text" style = "{%if count_reports == 0 and current_user.type != '–ê—É–¥–∏—Ç–æ—Ä'%}
                                    border-top-right-radius: 0;
                                    border-bottom-right-radius: 0; 
                                    background: white; 
                                    width: calc(100% - 70px);
                                    {%else%} {%endif%}" 
                                    placeholder="–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è"  name = "full_name_common" value="{{ current_user.organization.full_name if current_user.organization else '' }}" readonly>
                                    {%if count_reports == 0 and current_user.type != '–ê—É–¥–∏—Ç–æ—Ä'%}
                                        <a class="show_organiz" id = "link_chooseOrgModal"> 
                                            <img class="" src="{{ url_for('static', filename='img/Search.svg')}}" alt="">
                                        </a>
                                    {%else%} {%endif%}
                            </td>
                        </tr>
                        {%if current_user.type != '–ê—É–¥–∏—Ç–æ—Ä'%}
                            <tr>
                                <td><span title = "–û–±—â–µ—Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∏–π –∫–æ–¥ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏–π –∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π">–û–ö–ü–û</span></td>
                                <td>    
                                    <input 
                                    type="text" 
                                    name = "okpo_common" 
                                    placeholder="–û–∫–ø–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è" 
                                    value="{{current_user.organization.okpo if current_user.organization.okpo else ''}}" readonly>
                                </td>
                            </tr>
                            <tr>
                                <td><span title = "–£—á–µ—Ç–Ω—ã–π –Ω–æ–º–µ—Ä –ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ)">–£–ù–ü</span></td>
                                <td>    
                                    <input 
                                    type="text" 
                                    name = "ynp_common" 
                                    placeholder="–£–Ω–ø –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç–æ)" 
                                    value="{{current_user.organization.ynp if current_user.organization.ynp else '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}}" readonly>
                                </td>
                            </tr>
                            <tr>
                                <td><span title = "–†–µ—Å–ø—É–±–ª–∏–∫–∞–Ω—Å–∫–∏–π –æ—Ä–≥–∞–Ω –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è">–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ</span></td>
                                <td>    
                                    <input 
                                        type="text" 
                                        name = "ministry_common"  
                                        placeholder="–ú–∏–Ω–∏—Å—Ç–µ—Ä—Å—Ç–≤–æ –ø—Ä–µ–¥–ø—Ä–∏—è—Ç–∏—è" 
                                        value="{{current_user.organization.ministry if current_user.organization.ministry else '–í—ã—à–µ—Å—Ç–æ—è—â–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è'}}" readonly>
                                </td>
                            </tr>    
                        {%else%}
                        {%endif%}
                    </table>
                    <table>
                        <tr>
                            <td>E-mail &#42;</td>
                            <td>                        
                                <input type="text" value="{{current_user.email}}" readonly>
                            </td>
                        </tr>
                        <tr>
                            <td>–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ &#42;</td>
                            <td>
                                <div class="clear-input_container">
                                    <input 
                                        type="text" 
                                        name="telephone_common" 
                                        placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞" 
                                        value="{{current_user.telephone if current_user.telephone else ''}}" 
                                        required 
                                        id="telephone_input"  maxlength="13">
                                    <span class="clear-btn">
                                         &times; 
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </table>
                    <div class = "title-ab-func" style = "max-width: 100%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ &#42; ‚Äî –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è/–≤—ã–±–æ—Ä–∞.</div>
                    <button class = "blue_button" type="submit">
                        <img src="/static/img/Add.svg" alt="" class="button-icon">
                        <span>–ü—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                    </button>
                </form>
        </div>
    </div>
</div>

<div id="chooseOrgModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="change-position">–ü–æ–∏—Å–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</h3>
            <a class="close">&times;</a>
        </div>
        <div class="answer-highlight-second">
            <div class="highlight-icon">üí°</div>
            <p>–í–≤–µ–¥–∏—Ç–µ <strong>–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</strong> –∏–ª–∏ <strong>–û–ö–ü–û</strong> –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏. –í —Å–ª—É—á–∞–µ <strong>–û–¢–°–£–¢–°–¢–í–ò–Ø –û–†–ì–ê–ù–ò–ó–ê–¶–ò–ò</strong> –∑–∞–ø–æ–ª–Ω–∏—Ç–µ
                <a href="/#toadmin" class="instruction-link">–§–û–†–ú–£</a>, –¥–ª—è –µ—ë –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.</p>
        </div>

        <div class="search-cont">
            <label for="search_organization">–ü–æ–∏—Å–∫</label>
            <input name="search_organization" class="search_input" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –û–ö–ü–û">
        </div>
        <div class="spravochniki_area">
            <div class="organizations-table-container">
                <table class="organizations-table">
                    <thead>
                        <tr>
                            <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏</th>
                            <th>–û–ö–ü–û</th>
                        </tr>
                    </thead>
                    <tbody id="chooserOganizationTableBody">
                      
                    </tbody>
                </table>
            </div>
        </div>
        <div class="pagination-area" id="paginationArea" style="display: none;">
            <div class="pagination-container">
                <button id="prevPageBtn" class="pagination-btn prev-btn" aria-label="–ü—Ä–µ–¥—ã–¥—É—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                    <svg class="pagination-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                    </svg>
                </button>
                
                <div class="pagination-pages">
                    <span id="currentPage" class="page-current">1</span>
                    <span class="page-separator">/</span>
                    <span id="totalPages" class="page-total">1</span>
                </div>
                
                <button id="nextPageBtn" class="pagination-btn next-btn" aria-label="–°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞">
                    <svg class="pagination-icon" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z"/>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.querySelector('input[name="search_organization"]');
    const tableBody = document.getElementById("chooserOganizationTableBody");
    const chooseOrgModal = document.getElementById("chooseOrgModal");
    const linkChooseOrgModal = document.getElementById("link_chooseOrgModal");
    const closeChooseOrgModal = chooseOrgModal.querySelector(".close");
    const paginationArea = document.getElementById("paginationArea");
    const prevPageBtn = document.getElementById("prevPageBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');

    if (!searchInput || !tableBody || !chooseOrgModal || !linkChooseOrgModal || !closeChooseOrgModal) {
        console.error("–û—à–∏–±–∫–∞: –û–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.");
        return;
    }

    let searchQuery = "";
    let currentPage = 1;
    let hasNextPage = false;
    let isLoading = false;

    function loadOrganizations(page = 1, query = "") {
        if (isLoading) return;
        
        isLoading = true;
        currentPage = page;
        
        fetch(`/api/organizations?q=${query}&page=${page}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                tableBody.innerHTML = "";
                hasNextPage = data.has_next;
                
                currentPageEl.textContent = currentPage;
                totalPagesEl.textContent = data.total_pages || currentPage;

                if (!data.organizations.length) {
                    tableBody.innerHTML = '<tr><td colspan="2">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                    if (paginationArea) paginationArea.style.display = "none";
                } else {
                    data.organizations.forEach(org => {
                        const row = document.createElement("tr");
                        row.dataset.id = org.id;
                        row.innerHTML = `
                            <td>${org.full_name}</td>
                            <td>${org.okpo}</td>
                            <td style="display: none;">${org.ynp || ''}</td>
                            <td style="display: none;">${org.ministry || ''}</td>
                        `;
                        tableBody.appendChild(row);
                    });
                    
                    if (paginationArea) {
                        if (currentPage > 1 || hasNextPage) {
                            paginationArea.style.display = "block";
                        } else {
                            paginationArea.style.display = "none";
                        }
                    }
                }
                
                if (prevPageBtn) prevPageBtn.disabled = currentPage <= 1;
                if (nextPageBtn) nextPageBtn.disabled = !hasNextPage;
                
                isLoading = false;
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π:", error);
                tableBody.innerHTML = '<tr><td colspan="2">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>';
                if (paginationArea) paginationArea.style.display = "none";
                isLoading = false;
            });
    }

    let debounceTimer;
    searchInput.addEventListener("input", function () {
        clearTimeout(debounceTimer);
        searchQuery = this.value.trim();
        currentPage = 1;
        debounceTimer = setTimeout(() => loadOrganizations(1, searchQuery), 300);
    });

    if (prevPageBtn) {
        prevPageBtn.addEventListener("click", function () {
            if (currentPage > 1 && !isLoading) {
                loadOrganizations(currentPage - 1, searchQuery);
            }
        });
    }

    if (nextPageBtn) {
        nextPageBtn.addEventListener("click", function () {
            if (hasNextPage && !isLoading) {
                loadOrganizations(currentPage + 1, searchQuery);
            }
        });
    }

    linkChooseOrgModal.addEventListener("click", function () {
        chooseOrgModal.classList.add("active");
        currentPage = 1;
        searchInput.value = "";
        searchQuery = "";
        loadOrganizations(1);
    });

    tableBody.addEventListener("click", function (event) {
        if (event.target.tagName === "TD") {
            let row = event.target.closest("tr");
            if (!row) return;
            
            let orgData = {
                full_name: row.cells[0]?.textContent.trim() || '',
                okpo: row.cells[1]?.textContent.trim() || '',
                ynp: row.cells[2]?.textContent.trim() || '',
                ministry: row.cells[3]?.textContent.trim() || ''
            };

            const fullNameInput = document.querySelector('input[name="full_name_common"]');
            const okpoInput = document.querySelector('input[name="okpo_common"]');
            const ynpInput = document.querySelector('input[name="ynp_common"]');
            const ministryInput = document.querySelector('input[name="ministry_common"]');
            
            if (fullNameInput) fullNameInput.value = orgData.full_name;
            if (okpoInput) okpoInput.value = orgData.okpo;
            if (ynpInput) ynpInput.value = orgData.ynp;
            if (ministryInput) ministryInput.value = orgData.ministry;

            chooseOrgModal.classList.remove("active");
        }
    });

    closeChooseOrgModal.addEventListener("click", function () {
        chooseOrgModal.classList.remove("active");
    });

    chooseOrgModal.addEventListener("click", function (event) {
        if (event.target === chooseOrgModal) {
            chooseOrgModal.classList.remove("active");
        }
    });

    loadOrganizations(1);
});


document.getElementById('second_name_input').addEventListener('keypress', function (e) {
    const char = String.fromCharCode(e.which);
    if (!/^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s-]$/.test(char)) {
        e.preventDefault();
    }
});

document.getElementById('name_input').addEventListener('keypress', function (e) {
    const char = String.fromCharCode(e.which);
    if (!/^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s-]$/.test(char)) {
        e.preventDefault(); 
    }
});    

document.getElementById('patronymic_input').addEventListener('keypress', function (e) {
    const char = String.fromCharCode(e.which);
    if (!/^[A-Za-z–ê-–Ø–∞-—è–Å—ë\s-]$/.test(char)) {
        e.preventDefault();
    }
});

document.getElementById('telephone_input').addEventListener('keypress', function (e) {
    const char = String.fromCharCode(e.which);
    const currentValue = this.value;

    if (!/^[0-9]$/.test(char) && !(char === '+' && currentValue.length === 0)) {
        e.preventDefault();
    }
});

document.querySelectorAll('.clear-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const input = this.parentElement.querySelector('input');
        input.value = '';
        input.focus();
    });
});
</script>
{% endblock %}

