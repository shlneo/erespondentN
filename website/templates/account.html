{% extends "base.html" %}
{% block title %}–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç - ErespondentN{% endblock %}
{% block content %}

<div class = "account_cont">
    <div class = "privetstvie_cont">
        <a href = "/profile/session">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å{{' ' + current_user.fio.split()[0] + ' ' + current_user.fio.split()[1] if current_user.fio else ''}}</a>
    </div>
    <div class = "account_functions">
        <div class = "account_links">
            <button class = "account_buttons" onclick="window.location.href='/profile/common'">
                <div class="first_path">
                    <img src="{{ url_for('static', filename='img/people.png')}}"  alt="">
                    <span>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ—Ñ–∏–ª—è</span>
                </div>
                <svg fill="#002762" height="12" viewBox="0 0 7 12" width="7" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px;"><path d="M5.83327 4.23243L2.00911 0.410763C1.85043 0.267295 1.64267 0.19034 1.42882 0.195832C1.21498 0.201323 1.01143 0.288839 0.860333 0.440261C0.709232 0.591683 0.622148 0.795412 0.617111 1.00927C0.612074 1.22312 0.68947 1.43073 0.833274 1.5891L4.65494 5.41076C4.81117 5.56704 4.89893 5.77896 4.89893 5.99993C4.89893 6.2209 4.81117 6.43282 4.65494 6.5891L0.833274 10.4108C0.677017 10.5671 0.589277 10.7792 0.589356 11.0002C0.589434 11.2213 0.677324 11.4333 0.833691 11.5895C0.990058 11.7458 1.20209 11.8335 1.42315 11.8334C1.64421 11.8334 1.85618 11.7455 2.01244 11.5891L5.83327 7.76743C6.30195 7.29861 6.56524 6.66284 6.56524 5.99993C6.56524 5.33702 6.30195 4.70125 5.83327 4.23243Z"></path></svg>
            </button>
            <button class = "account_buttons" onclick="window.location.href='/FAQ'">
                <div class="first_path">
                    <img src="{{ url_for('static', filename='img/faq.png')}}"  alt="">
                    <span>–û—Ç–≤–µ—Ç—ã –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã</span>
                </div>
                <svg fill="#002762" height="12" viewBox="0 0 7 12" width="7" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px;"><path d="M5.83327 4.23243L2.00911 0.410763C1.85043 0.267295 1.64267 0.19034 1.42882 0.195832C1.21498 0.201323 1.01143 0.288839 0.860333 0.440261C0.709232 0.591683 0.622148 0.795412 0.617111 1.00927C0.612074 1.22312 0.68947 1.43073 0.833274 1.5891L4.65494 5.41076C4.81117 5.56704 4.89893 5.77896 4.89893 5.99993C4.89893 6.2209 4.81117 6.43282 4.65494 6.5891L0.833274 10.4108C0.677017 10.5671 0.589277 10.7792 0.589356 11.0002C0.589434 11.2213 0.677324 11.4333 0.833691 11.5895C0.990058 11.7458 1.20209 11.8335 1.42315 11.8334C1.64421 11.8334 1.85618 11.7455 2.01244 11.5891L5.83327 7.76743C6.30195 7.29861 6.56524 6.66284 6.56524 5.99993C6.56524 5.33702 6.30195 4.70125 5.83327 4.23243Z"></path></svg>
            </button>
            {%if current_user.type == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' or current_user.type == '–†–µ—Å–ø–æ–Ω–¥–µ–Ω—Ç'%}
                <button class = "button_account_add_report blue_button" onclick="window.location.href='/report-area'" type="" class = "">
                    <span style = "font-size: 20px;">+</span>
                    <span>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç—á–µ—Ç</span>
                </button>
            {%else%}
            {%endif%}
            {%if current_user.type == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' or current_user.type == '–ê—É–¥–∏—Ç–æ—Ä'%}
             <button class = "account_buttons" onclick="window.location.href='/audit-area/not_viewed?year={{previous_year}}&quarter={{previous_quarter}}';">
                <div class="first_path">
                    <img src="{{ url_for('static', filename='img/audit_icon.png')}}"  alt="">
                    <span>–ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—á–µ—Ç–æ–≤</span>
                </div>
                <svg fill="#002762" height="12" viewBox="0 0 7 12" width="7" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px;"><path d="M5.83327 4.23243L2.00911 0.410763C1.85043 0.267295 1.64267 0.19034 1.42882 0.195832C1.21498 0.201323 1.01143 0.288839 0.860333 0.440261C0.709232 0.591683 0.622148 0.795412 0.617111 1.00927C0.612074 1.22312 0.68947 1.43073 0.833274 1.5891L4.65494 5.41076C4.81117 5.56704 4.89893 5.77896 4.89893 5.99993C4.89893 6.2209 4.81117 6.43282 4.65494 6.5891L0.833274 10.4108C0.677017 10.5671 0.589277 10.7792 0.589356 11.0002C0.589434 11.2213 0.677324 11.4333 0.833691 11.5895C0.990058 11.7458 1.20209 11.8335 1.42315 11.8334C1.64421 11.8334 1.85618 11.7455 2.01244 11.5891L5.83327 7.76743C6.30195 7.29861 6.56524 6.66284 6.56524 5.99993C6.56524 5.33702 6.30195 4.70125 5.83327 4.23243Z"></path></svg>
            </button>
            <button class = "account_buttons" id = "link_stats">
                <div class="first_path">
                    <img src="{{ url_for('static', filename='img/report.png')}}"  alt="">
                    <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
                </div>
                <svg fill="#002762" height="12" viewBox="0 0 7 12" width="7" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px;"><path d="M5.83327 4.23243L2.00911 0.410763C1.85043 0.267295 1.64267 0.19034 1.42882 0.195832C1.21498 0.201323 1.01143 0.288839 0.860333 0.440261C0.709232 0.591683 0.622148 0.795412 0.617111 1.00927C0.612074 1.22312 0.68947 1.43073 0.833274 1.5891L4.65494 5.41076C4.81117 5.56704 4.89893 5.77896 4.89893 5.99993C4.89893 6.2209 4.81117 6.43282 4.65494 6.5891L0.833274 10.4108C0.677017 10.5671 0.589277 10.7792 0.589356 11.0002C0.589434 11.2213 0.677324 11.4333 0.833691 11.5895C0.990058 11.7458 1.20209 11.8335 1.42315 11.8334C1.64421 11.8334 1.85618 11.7455 2.01244 11.5891L5.83327 7.76743C6.30195 7.29861 6.56524 6.66284 6.56524 5.99993C6.56524 5.33702 6.30195 4.70125 5.83327 4.23243Z"></path></svg>
            </button>
        {%else%}
        {%endif%}

        {%if current_user.type == '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä'%}
            <button class = "account_buttons" onclick="window.location.href='/admin'">
                <div class="first_path">
                    <img src="{{ url_for('static', filename='img/icon_admin-panel.png')}}"  alt="">
                    <span>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</span>
                </div>
                <svg fill="#002762" height="12" viewBox="0 0 7 12" width="7" xmlns="http://www.w3.org/2000/svg" style="margin-left: 4px;"><path d="M5.83327 4.23243L2.00911 0.410763C1.85043 0.267295 1.64267 0.19034 1.42882 0.195832C1.21498 0.201323 1.01143 0.288839 0.860333 0.440261C0.709232 0.591683 0.622148 0.795412 0.617111 1.00927C0.612074 1.22312 0.68947 1.43073 0.833274 1.5891L4.65494 5.41076C4.81117 5.56704 4.89893 5.77896 4.89893 5.99993C4.89893 6.2209 4.81117 6.43282 4.65494 6.5891L0.833274 10.4108C0.677017 10.5671 0.589277 10.7792 0.589356 11.0002C0.589434 11.2213 0.677324 11.4333 0.833691 11.5895C0.990058 11.7458 1.20209 11.8335 1.42315 11.8334C1.64421 11.8334 1.85618 11.7455 2.01244 11.5891L5.83327 7.76743C6.30195 7.29861 6.56524 6.66284 6.56524 5.99993C6.56524 5.33702 6.30195 4.70125 5.83327 4.23243Z"></path></svg>
            </button>
        {%else%}
        {%endif%}
            
        </div>
        <div class = "account_messages">
            <div class = "account_messageArea">
                <img src="{{ url_for('static', filename='img/icon_messages.png')}}"  alt="">
                <span>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</span>
            </div>
            <div class="message_cont" id="messagesContainer">
                {% if messages %}
                    {% for row in messages %}
                    <div class="mes" id="message-{{ row.id }}">
                        <div class="message_header">
                            <div class="time_mes">
                                {{ row.create_time.strftime('%d.%m.%Y %H:%M') }}
                                {% if row.sender_id != None %} 
                                - <span class="sender">{{ row.sender.email }}</span>
                                {% endif %}
                            </div>
                            <div class="message_actions">
                                <button class="delete_btn" 
                                        onclick="deleteMessage({{ row.id }})"
                                        title="–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ"
                                        data-message-id="{{ row.id }}">
                                    ‚úï
                                </button>
                            </div>
                        </div>
                        <div class="text_mes">{{ row.text }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                <div class="mes empty">
                    <div class="text_mes">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="load_stats_modal" class="modal">
    <div class="modal-content">
        <div class = "modal-header">
            <h3 class = "change-position">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏</h3>
            <a class="close" id = "Closeperiod_modal">&times;</a>
        </div>
        <div class="answer-highlight-second" style = "max-width: 510px;">
            <div class="highlight-icon">üí°</div>
            <p>–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–π <strong>–≥–æ–¥</strong> –∏ <strong>–∫–≤–∞—Ä—Ç–∞–ª</strong>, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –æ—Ç—á–µ—Ç –æ —Å–ø–∏—Å–∫–µ <strong>–æ—Ç—á–∏—Ç–∞–≤—à–∏—Ö—Å—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–π</strong>.</p>
        </div>
        <form action="/load_org_stat" method="POST">
            <table class="modal_table">      
                <tr>
                    <td>–ì–æ–¥</td>
                    <td>
                        <div class="input-container">
                            <button class = "inc_button" type="button" onclick="coppy_decrement_year()">-</button>
                            <input  class = "inc_dis_input" type="text" id="coppy_quantity_year" value="{{previous_year}}" name="modal_report_year" readonly>
                            <button class = "dis_button" type="button" onclick="coppy_increment_year()">+</button>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>–ö–≤–∞—Ä—Ç–∞–ª</td>
                    <td>
                        <div class="input-container">
                            <button class = "inc_button" type="button" onclick="coppy_decrement_quarter()">-</button>
                            <input  class = "inc_dis_input" type="text" id="coppy_quantity_quarter" value="{{previous_quarter}}" name="modal_report_quarter" readonly>
                            <button class = "dis_button" type="button" onclick="coppy_increment_quarter()">+</button>
                        </div>
                    </td>
                </tr>
            </table>
            <div class="model_but_area" >
                <button type="submit" class="blue_button">
                    <img src="/static/img/Calendar.svg" alt="" class="button-icon">
                    <span>–í—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</span>
                </button>
            </div>
        </form>
    </div>
</div>
<script>
function deleteMessage(messageId) {
    const messageElement = document.getElementById(`message-${messageId}`);
    const deleteBtn = messageElement.querySelector('.delete_btn');
    
    const originalText = deleteBtn.innerHTML;
    
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '–û—Ç–º–µ–Ω–∞ (5)';
    deleteBtn.style.opacity = '0.7';
    deleteBtn.style.cursor = 'default';
    
    let secondsLeft = 5;
    const countdown = setInterval(() => {
        secondsLeft--;
        deleteBtn.innerHTML = `–û—Ç–º–µ–Ω–∞ (${secondsLeft})`;
        
        if (secondsLeft <= 0) {
            clearInterval(countdown);
            executeDeletion(messageId, messageElement, deleteBtn, originalText);
        }
    }, 1000);
    
    const cancelDeletion = () => {
        clearInterval(countdown);
        resetDeleteButton(deleteBtn, originalText);
        showNotification('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'info');
        deleteBtn.removeEventListener('click', cancelDeletion);
    };
    
    deleteBtn.addEventListener('click', cancelDeletion);
    
    setTimeout(() => {
        clearInterval(countdown);
        if (!deleteBtn.disabled) {
            executeDeletion(messageId, messageElement, deleteBtn, originalText);
        }
    }, 5000);
}

function executeDeletion(messageId, messageElement, deleteBtn, originalText) {
    deleteBtn.removeEventListener('click', deleteBtn.__cancelHandler);
    
    deleteBtn.innerHTML = '‚åõ';
    
    fetch(`/delete_message/${messageId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageElement.style.transition = 'all 0.3s ease';
            messageElement.style.height = messageElement.offsetHeight + 'px';
            
            setTimeout(() => {
                messageElement.style.height = '0';
                messageElement.style.padding = '0';
                messageElement.style.margin = '0';
                messageElement.style.opacity = '0';
                messageElement.style.border = 'none';
                messageElement.style.overflow = 'hidden';
                
                setTimeout(() => {
                    messageElement.remove();
                    
                    checkEmptyState();
                    updateMessageCount(data.remaining_count);
                }, 300);
            }, 50);
        } else {
            showNotification(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏', 'error');
            resetDeleteButton(deleteBtn, originalText);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
        resetDeleteButton(deleteBtn, originalText);
    });
}

function checkEmptyState() {
    const container = document.getElementById('messagesContainer');
    const messages = container.querySelectorAll('.mes:not(.empty)');
    
    if (messages.length === 0) {
        if (!container.querySelector('.mes.empty')) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'mes empty';
            emptyDiv.innerHTML = `
                <div class="text_mes">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
            `;
            container.appendChild(emptyDiv);
        }
    } else {
        const emptyState = container.querySelector('.mes.empty');
        if (emptyState) {
            emptyState.remove();
        }
    }
}

function updateMessageCount(count) {
    const countElement = document.getElementById('messageCount');
    if (countElement) {
        countElement.textContent = count;
    }
}

function resetDeleteButton(button, originalText) {
    button.disabled = false;
    button.innerHTML = originalText;
    button.style.opacity = '0.7';
    button.style.cursor = 'pointer';
}

function showNotification(text, type) {
    const notification = document.createElement('div');
    notification.textContent = text;
    
    let backgroundColor;
    switch(type) {
        case 'success':
            backgroundColor = '#48bb78';
            break;
        case 'error':
            backgroundColor = '#f56565';
            break;
        case 'info':
            backgroundColor = '#4299e1';
            break;
        default:
            backgroundColor = '#4299e1';
    }
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        background: ${backgroundColor};
        color: white;
        border-radius: 6px;
        z-index: 1000;
        animation: slideIn 0.3s ease;
        font-size: 14px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { 
            transform: translateX(100%); 
            opacity: 0; 
        }
        to { 
            transform: translateX(0); 
            opacity: 1; 
        }
    }
    @keyframes slideOut {
        from { 
            transform: translateX(0); 
            opacity: 1; 
        }
        to { 
            transform: translateX(100%); 
            opacity: 0; 
        }
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}